{% extends "base.html" %} {% block title %} AuSam - RSVP {% endblock %}
{% block content %}
    
<body>
    <hr>

    <div id="nameModal" class="modal">
        <div class="modal-content">
          <h2>Enter full name to retrieve invite</h2>
          <form id="name-form">
            <input type="text" id="name-input" required>
            <span id="name-error-message"></span>
            <button type="submit" id="modalSubmit">Submit</button>
          </form>
        </div>
    </div>

    <div id="attendance-form-wrapper" style="display: none;">
        <form id="attendance-form">
            <fieldset>
                <label for="full-name">Guest: <span id="full-name-display"></span></label>
                <input id="full-name" name="full-name" type="hidden" required />
    
                <div class="attending-button-container">
                    <label for="acceptedButton">Attending:</label>
                    <button type="button" id="acceptedButton" class="attending-button">Accepted</button>
            
                    <label for="declineButton"></label>
                    <button type="button" id="declineButton" class="attending-button">Decline</button>
                    
                    <input type="hidden" id="attendingInput" name="attending" value="" required>
                </div>
                
                <div class="radio-group">
                    <div class="radio-buttons">
                        <label>
                            <input type="radio" name="food-preference" value="lamb" required />
                            <span class="radio"></span>
                            <span class="label">Lamb stuffed with sausage</span>
                        </label>
                        <label>
                            <input type="radio" name="food-preference" value="vegetarian" required />
                            <span class="radio"></span>
                            <span class="label">Eggplant parmesan (vegetarian)</span>
                        </label>
                    </div>
                </div>

                <div class="text-group">
                    <label for="dietary-restrictions">Dietary restrictions<input type="text" id="dietary-restrictions" name="dietary-restrictions" /></label>
                </div>

                <div class="radio-group">
                    <label class="question-label" for="babysitter">Do you need a babysitter for this child for the wedding day?</label>
                    <div class="radio-buttons">
                        <label>
                            <input type="radio" name="babysitter" value="yes" required />
                            <span class="radio"></span>
                            <span class="label">Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="babysitter" value="no" required />
                            <span class="radio"></span>
                            <span class="label">No</span>
                        </label>
                    </div>
                </div>

                <div class="radio-group">
                    <label for="welcome-dinner">Will you joining us for the welcome dinner at Da Giovannino on October 23, 2024?</label>
                    <div class="radio-buttons">
                        <label>
                            <input type="radio" name="welcome-dinner" value="yes" required />
                            <span class="radio"></span>
                            <span class="label">Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="welcome-dinner" value="no" required />
                            <span class="radio"></span>
                            <span class="label">No</span>
                        </label>
                    </div>
                    <div class="radio-buttons">
                        <label>
                            <input type="radio" name="welcom-meal" value="vegetarian" required />
                            <span class="radio"></span>
                            <span class="label">Vegetarian</span>
                        </label>
                        <label>
                            <input type="radio" name="welcome-meal" value="kids-meal" required />
                            <span class="radio"></span>
                            <span class="label">Kid's meal</span>
                        </label>
                        <label>
                            <input type="radio" name="welcome-meal" value="NA" required />
                            <span class="radio"></span>
                            <span class="label">N/A</span>
                        </label>
                    </div>
                </div>

                <div class="radio-group">
                    <label for="pizza">Will you be joining us for the pizza party at the hotel on October 25, 2024?</label>
                    <div class="radio-buttons">
                        <label>
                            <input type="radio" name="pizza" value="yes" required />
                            <span class="radio"></span>
                            <span class="label">Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="pizza" value="no" required />
                            <span class="radio"></span>
                            <span class="label">No</span>
                        </label>
                    </div>
                    <div class="radio-buttons">
                        <label>
                            <input type="radio" name="pizza-meal" value="vegetarian" required />
                            <span class="radio"></span>
                            <span class="label">Vegetarian</span>
                        </label>
                        <label>
                            <input type="radio" name="pizza-meal" value="kids-meal" required />
                            <span class="radio"></span>
                            <span class="label">Kid's meal</span>
                        </label>
                        <label>
                            <input type="radio" name="pizza-meal" value="NA" required />
                            <span class="radio"></span>
                            <span class="label">N/A</span>
                        </label>
                    </div>
                </div>

                
                <div class="radio-group">
                    <label class="question-label" for="stay">How many days will you remain on site?</label>
                    <div class="radio-buttons">
                        <label>
                            <input type="radio" name="stay" value="1" required />
                            <span class="radio"></span>
                            <span class="label">1</span>
                        </label>
                        <label>
                            <input type="radio" name="stay" value="2" required />
                            <span class="radio"></span>
                            <span class="label">2</span>
                        </label>
                        <label>
                            <input type="radio" name="stay" value="3" required />
                            <span class="radio"></span>
                            <span class="label">3</span>
                    </div>
                </div>

            </fieldset>
        </form>
    </div>

    <div id="form-container-wrapper">
        <form id="form-container" action="submit-rsvp/" method="post">
            <button type="submit" id="submitButton">Submit</button>
        </form>
    </div>

    <script>
        // Show the modal when the page loads
        window.onload = function() {
            document.getElementById('nameModal').style.display = 'block';
            document.getElementById('form-container').style.display = 'none';
        };

        // When the name form is submitted, send an AJAX request to the server
        document.getElementById('name-form').addEventListener('submit', function(e) {
            e.preventDefault();

            var name = document.getElementById('name-input').value;

            // TODO: Add validation for the name input and ignore case

            fetch('/get_invite?name=' + name)
            .then(response => response.json())
            .then(data => {
                console.log("Data from server:");
                console.log(data);

                if (data.error) {
                    // Find the name input field and the error message element
                    let nameInput = document.getElementById('name-input');
                    let errorMessage = document.getElementById('name-error-message');

                    // Set the error message and make it visible
                    errorMessage.textContent = data.error;
                    errorMessage.style.display = 'block';

                    return;
                }

                // process list of users on the invite
                var allUsersOnInvite = data.all_users_on_invite;

                allUsersOnInvite.forEach(user => {

                    // Get the original form and clone it
                    let originalForm = document.getElementById('attendance-form');
                    let form = originalForm.cloneNode(true);

                    // Update the form's ID
                    form.id = `attendance-form-${user.name.replace(/ /g, "-")}`;
                    console.log("form id: " + form.id);

                    // Populate the form's fields
                    let fullNameInput = form.querySelector("#full-name");
                    fullNameInput.value = user.name;
                    console.log("full name: " + fullNameInput.value);
                    let fullNameDisplay = form.querySelector('#full-name-display');
                    fullNameDisplay.textContent = " " + fullNameInput.value;
                    console.log("full name display: " + fullNameDisplay.textContent);

                    let attendingInput = form.querySelector('input[name="attending"]');
                    attendingInput.value = user.attending;
                    console.log("attending: " + attendingInput.value);

                    // Toggle the buttons based on the attending value
                    let acceptedButton = form.querySelector('#acceptedButton');
                    let declineButton = form.querySelector('#declineButton');

                    // Check if buttons exist
                    if (!acceptedButton || !declineButton) {
                    console.log('Button not found');
                    return;
                    }

                    acceptedButton.addEventListener('click', function(event) {
                        event.stopPropagation();
                        handleButtonClick(form.id, 'accepted');
                    });
                    
                    declineButton.addEventListener('click', function(event) {
                        event.stopPropagation();
                        handleButtonClick(form.id, 'decline');
                    });

                    if (attendingInput.value === 'accepted') {
                        acceptedButton.classList.add('selected');
                        declineButton.classList.remove('selected');
                    } 
                    else if (attendingInput.value === 'decline') {
                        acceptedButton.classList.remove('selected');
                        declineButton.classList.add('selected');
                    }

                    let foodPreferenceInputs = form.querySelectorAll('input[name="food-preference"]');
                    foodPreferenceInputs.forEach(input => {
                        if (input.value === user.meal) {
                            input.checked = true;
                        }
                    });
                    console.log("food preference: " + user.meal);

                    let dietaryRestrictionsInput = form.querySelector('input[name="dietary-restrictions"]');
                    if (user.dietaryRestrictions) {
                        dietaryRestrictionsInput.value = user.dietary_restrictions;
                    }
                    console.log("dietary restrictions: " + dietaryRestrictionsInput.value);

                    let babysitterInputs = form.querySelectorAll('input[name="babysitter"]');
                    babysitterInputs.forEach(input => {
                        if (input.value === user.babysitter) {
                            input.checked = true;
                        }
                    });
                    console.log("babysitter: " + user.babysitter);

                    let welcomeDinnerInputs = form.querySelectorAll('input[name="welcome-dinner"]');
                    welcomeDinnerInputs.forEach(input => {
                        if (input.value === user.welcome_dinner) {
                            input.checked = true;
                        }
                    });
                    console.log("welcome dinner: " + user.welcome_dinner);

                    let welcomeMealInputs = form.querySelectorAll('input[name="welcome-meal"]');
                    welcomeMealInputs.forEach(input => {
                        if (input.value === user.welcome_meal) {
                            input.checked = true;
                        }
                    });
                    console.log("welcome meal: " + user.welcome_meal);

                    let pizzaInputs = form.querySelectorAll('input[name="pizza"]');
                    pizzaInputs.forEach(input => {
                        if (input.value === user.pizza) {
                            input.checked = true;
                        }
                    });
                    console.log("pizza: " + user.pizza);

                    let pizzaMealInputs = form.querySelectorAll('input[name="pizza-meal"]');
                    pizzaMealInputs.forEach(input => {
                        if (input.value === user.pizza_meal) {
                            input.checked = true;
                        }
                    });
                    console.log("pizza meal: " + user.pizza_meal);

                    let stayInputs = form.querySelectorAll('input[name="stay"]');
                    stayInputs.forEach(input => {
                        if (input.value === user.stay) {
                            input.checked = true;
                        }
                    });
                    console.log("stay: " + user.stay);

                    // Append the form to the body of the document
                    document.getElementById('nameModal').style.display = 'none';
                    form.style.display = 'block';
                    document.getElementById('form-container').style.display = 'block';
                    document.getElementById('form-container').prepend(form);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        function handleButtonClick(child_form, option) {
            console.log('handleButtonClick called with child_form:', child_form, 'and option:', option);

            // Get the form and check if it exists
            let form = document.getElementById(child_form);
            if (!form) {
                console.log('Form not found:', child_form);
                return;
            }

            // Get the attendingInput and check if it exists
            let attendingInput = form.querySelector('#attendingInput');
            if (!attendingInput) {
                console.log('attendingInput not found in form:', child_form);
                return;
            }

            // Update the hidden input value in the form
            attendingInput.value = option;

            // Get the acceptedButton and check if it exists
            let acceptedButton = form.querySelector('#acceptedButton');
            if (!acceptedButton) {
                console.log('acceptedButton not found in form:', child_form);
                return;
            }

            // Get the declineButton and check if it exists
            let declineButton = form.querySelector('#declineButton');
            if (!declineButton) {
                console.log('declineButton not found in form:', child_form);
                return;
            }

            // Style the buttons to indicate the selected option
            acceptedButton.classList.toggle('selected', option === 'accepted');
            declineButton.classList.toggle('selected', option === 'decline');

        }

        // Process data from form before sending it server-side
        document.addEventListener("DOMContentLoaded", function() {
            console.log(document.getElementById('form-container'));
            document.getElementById('form-container').addEventListener('submit', function (event) {

                console.log("form-contianer Form submitted");
                
                // Needed this line to stop bug causing form to submit twice when I moved it to Django
                event.stopImmediatePropagation();
                // Prevent the default form submission
                event.preventDefault();

                // Get all form data 
                var formDataArray = [];

                var forms = event.target.querySelectorAll('form');
                forms.forEach(function(form) {
                    // Create a FormData object for each form
                    var formData = new FormData(form);
                    // Convert the form data to an object
                    var formDataObject = {};
                    // TODO: do this individually for each field and have type specific checks for each
                    formData.forEach(function (value, key) {
                        formDataObject[key] = value;
                    });
                    // Add the object to the array
                    formDataArray.push(formDataObject);
                });

                console.log("formDataArray: ");
                console.log(formDataArray);

                // Store the form data in local storage
                //This is robably not needed - TODO: remove
                formDataArray.forEach(function(form){
                    console.log("form: ");
                    console.log(form);
                    let name = form['full-name'];
                    localStorage.setItem(`${name}_Data`, JSON.stringify(form));
                });

                // Use a relative path to send the data to the Django view
                fetch('../../submit-rsvp/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formDataArray),
                })
                .then(response => {
                    if (response.headers.get("content-type").includes("application/json")) {
                        return response.json();
                    } else {
                        throw new Error('Received content type ' + response.headers.get("content-type"));
                    }
                })
                .then(data => {
                    // Handle the response from the server if needed
                    console.log("Response from server:");
                    console.log(data);
                })
                .catch(error => {
                    // Handle errors
                    console.error('Error:', error);
                });

                console.log("formDataArray after fetch:");
                console.log(JSON.stringify(formDataArray));

                // Reset the form or redirect the user as needed
                event.target.reset();
            });
        });

        document.addEventListener('submit', function (event) {
            console.log('Submit event fired');
        });

    </script>

</body>

{% endblock %}