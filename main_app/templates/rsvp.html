{% extends "base.html" %} {% block title %} AuSam - RSVP {% endblock %}
{% block content %}
    
<body>
    <hr>

    <div id="nameModal" class="modal">
        <div class="modal-content">
          <h2>Enter full name to retrieve invite</h2>
          <form id="name-form">
            <input type="text" id="name-input" required>
            <span id="name-error-message"></span>
            <button type="submit" id="modalSubmit">Submit</button>
          </form>
        </div>
    </div>

    <div id="attendance-form-wrapper" style="display: none;">
        <form id="attendance-form">
            <fieldset>
                <label for="full-name">Guest: <span id="full-name-display"></span></label>
                <input id="full-name" name="full-name" type="hidden" required />
    
                <div class="attending-button-container">
                    <label for="acceptedButton">Attending:</label>
                    <button type="button" id="acceptedButton" class="attending-button">Accepted</button>
            
                    <label for="declineButton"></label>
                    <button type="button" id="declineButton" class="attending-button">Decline</button>
                    
                    <input type="hidden" id="attendingInput" name="attending" value="" required>
                    <input type="hidden" id="is_child" name="is_child" value="false">
                </div>
                
                <div class="radio-group secondary-question" id="wedding-meal">
                    <div class="radio-buttons">
                        <label>Wedding meal:</label>
                        <label>
                            <input type="radio" name="food-preference" value="lamb" required />
                            <span class="radio"></span>
                            <span class="label">Lamb stuffed with sausage</span>
                        </label>
                        <label>
                            <input type="radio" name="food-preference" value="vegetarian" required />
                            <span class="radio"></span>
                            <span class="label">Eggplant parmesan (vegetarian)</span>
                        </label>
                    </div>
                </div>

                <div class="text-group secondary-question">
                    <label for="dietary-restrictions">Dietary restrictions<input type="text" id="dietary-restrictions" name="dietary-restrictions" /></label>
                </div>

                <div class="text-group secondary-question">
                    <label for="song-request">Song request<input type="text" id="song-request" name="song-request" /></label>
                </div>


                <div class="radio-group secondary-question"  id="babysitter-question">
                    <label class="question-label" for="babysitter">Do you need a babysitter for this child for the wedding day?</label>
                    <div class="radio-buttons">
                        <label>
                            <input type="radio" name="babysitter" value="yes" required />
                            <span class="radio"></span>
                            <span class="label">Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="babysitter" value="no" required />
                            <span class="radio"></span>
                            <span class="label">No</span>
                        </label>
                    </div>
                </div>

                <div class="radio-group secondary-question">
                    <label for="welcome-dinner">Will you joining us for the welcome dinner at Da Giovannino on October 23, 2024?</label>
                    <div class="radio-buttons primary-question" data-linked-question="welcome-meal">
                        <label>
                            <input type="radio" name="welcome-dinner" value="yes" required />
                            <span class="radio"></span>
                            <span class="label">Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="welcome-dinner" value="no" required />
                            <span class="radio"></span>
                            <span class="label">No</span>
                        </label>
                    </div>
                    <div class="radio-buttons tertiary-question" data-question-id="welcome-meal" style="display: none;">
                        <label>Menu options:</label>
                        <label>
                            <input type="radio" name="welcome-meal" value="meat" required />
                            <span class="radio"></span>
                            <span class="label">Meat</span>
                        </label>
                        <label>
                            <input type="radio" name="welcome-meal" value="vegetarian" required />
                            <span class="radio"></span>
                            <span class="label">Vegetarian</span>
                        </label>
                        <label>
                            <input type="radio" name="welcome-meal" value="kids-meal" required />
                            <span class="radio"></span>
                            <span class="label">Kid's meal</span>
                        </label>
                        <label>
                            <input type="radio" name="welcome-meal" value="NA" required />
                            <span class="radio"></span>
                            <span class="label">N/A</span>
                        </label>
                    </div>
                </div>

                <div class="radio-group secondary-question">
                    <label for="pizza">Will you be joining us for the pizza party at the hotel on October 25, 2024?</label>
                    <div class="radio-buttons primary-question" data-linked-question="pizza-meal">
                        <label>
                            <input type="radio" name="pizza" value="yes" required />
                            <span class="radio"></span>
                            <span class="label">Yes</span>
                        </label>
                        <label>
                            <input type="radio" name="pizza" value="no" required />
                            <span class="radio"></span>
                            <span class="label">No</span>
                        </label>
                    </div>
                    <div class="radio-buttons tertiary-question" data-question-id="pizza-meal" style="display: none;">
                        <label>Menu options:</label>
                        <label>
                            <input type="radio" name="pizza-meal" value="meat" required />
                            <span class="radio"></span>
                            <span class="label">Meat</span>
                        </label>
                        <label>
                            <input type="radio" name="pizza-meal" value="vegetarian" required />
                            <span class="radio"></span>
                            <span class="label">Vegetarian</span>
                        </label>
                        <label>
                            <input type="radio" name="pizza-meal" value="kids-meal" required />
                            <span class="radio"></span>
                            <span class="label">Kid's meal</span>
                        </label>
                        <label>
                            <input type="radio" name="pizza-meal" value="NA" required />
                            <span class="radio"></span>
                            <span class="label">N/A</span>
                        </label>
                    </div>
                </div>

                
                <div class="radio-group secondary-question">
                    <label class="question-label" for="stay">How many days will you remain on site?</label>
                    <div class="radio-buttons">
                        <label>
                            <input type="radio" name="stay" value="1" required />
                            <span class="radio"></span>
                            <span class="label">1</span>
                        </label>
                        <label>
                            <input type="radio" name="stay" value="2" required />
                            <span class="radio"></span>
                            <span class="label">2</span>
                        </label>
                        <label>
                            <input type="radio" name="stay" value="3" required />
                            <span class="radio"></span>
                            <span class="label">3</span>
                    </div>
                </div>

            </fieldset>
        </form>
    </div>

    <div id="form-container">
        <button type="submit" id="submit-button">Submit</button>
    </div>

    <script>
        // Show the modal when the page loads
        window.onload = function() {
            document.getElementById('nameModal').style.display = 'block';
            document.getElementById('form-container').style.display = 'none';
        };

        // When the name form is submitted, send an AJAX request to the server
        document.getElementById('name-form').addEventListener('submit', function(e) {
            e.preventDefault();

            var name = document.getElementById('name-input').value;

            // TODO: Add validation for the name input and ignore case

            fetch('/get_invite?name=' + name)
            .then(response => response.json())
            .then(data => {
                console.log("Data from server:");
                console.log(data);

                if (data.error) {
                    // Find the name input field and the error message element
                    let nameInput = document.getElementById('name-input');
                    let errorMessage = document.getElementById('name-error-message');

                    // Set the error message and make it visible
                    errorMessage.textContent = data.error;
                    errorMessage.style.display = 'block';

                    return;
                }

                // process list of users on the invite
                var allUsersOnInvite = data.all_users_on_invite;

                allUsersOnInvite.forEach(user => {

                    // Get the original form and clone it
                    let originalForm = document.getElementById('attendance-form');
                    let form = originalForm.cloneNode(true);

                    // Update the form's ID
                    form.id = `attendance-form-${user.name.replace(/ /g, "-")}`;
                    console.log("form id: " + form.id);

                    // Populate the form's fields
                    let fullNameInput = form.querySelector("#full-name");
                    fullNameInput.value = user.name;
                    console.log("full name: " + fullNameInput.value);
                    let fullNameDisplay = form.querySelector('#full-name-display');
                    fullNameDisplay.textContent = " " + fullNameInput.value;
                    console.log("full name display: " + fullNameDisplay.textContent);

                    let attendingInput = form.querySelector('input[name="attending"]');
                    attendingInput.value = user.attending;
                    console.log("attending: " + attendingInput.value);

                    // Toggle the buttons based on the attending value
                    let acceptedButton = form.querySelector('#acceptedButton');
                    let declineButton = form.querySelector('#declineButton');

                    // Check if buttons exist
                    if (!acceptedButton || !declineButton) {
                    console.log('Button not found');
                    return;
                    }

                    acceptedButton.addEventListener('click', function(event) {
                        event.stopPropagation();
                        handleButtonClick(form.id, 'accepted');
                    });
                    
                    declineButton.addEventListener('click', function(event) {
                        event.stopPropagation();
                        handleButtonClick(form.id, 'decline');
                    });

                    // Select the button based on loaded attending value
                    if (attendingInput.value === 'accepted') {
                        acceptedButton.classList.add('selected');
                        declineButton.classList.remove('selected');
                    } 
                    else if (attendingInput.value === 'decline') {
                        acceptedButton.classList.remove('selected');
                        declineButton.classList.add('selected');
                    }

                    let foodPreferenceInputs = form.querySelectorAll('input[name="food-preference"]');
                    foodPreferenceInputs.forEach(input => {
                        if (input.value === user.meal) {
                            input.checked = true;
                        }
                    });
                    console.log("food preference: " + user.meal);

                    let dietaryRestrictionsInput = form.querySelector('input[name="dietary-restrictions"]');
                    if (user.dietary_restrictions) {
                        dietaryRestrictionsInput.value = user.dietary_restrictions;
                    }
                    console.log("dietary restrictions: " + dietaryRestrictionsInput.value);

                    let songRequestInput = form.querySelector('input[name="song-request"]');
                    if (user.song_request) {
                        songRequestInput.value = user.song_request;
                    }
                    console.log("song request: " + songRequestInput.value);

                    
                    let is_child = form.querySelector('input[name="is_child"]');
                    is_child.value = user.is_child;
                    console.log("is_child: " + is_child.value);

                    let babysitterInputs = form.querySelectorAll('input[name="babysitter"]');
                    babysitterInputs.forEach(input => {
                        if (input.value === user.babysitter) {
                            input.checked = true;
                        }
                    });
                    console.log("babysitter: " + user.babysitter);

                    let welcomeDinnerInputs = form.querySelectorAll('input[name="welcome-dinner"]');
                    welcomeDinnerInputs.forEach(input => {
                        if (input.value === user.welcome_dinner) {
                            input.checked = true;
                        }
                    });
                    console.log("welcome dinner: " + user.welcome_dinner);

                    let welcomeMealInputs = form.querySelectorAll('input[name="welcome-meal"]');
                    welcomeMealInputs.forEach(input => {
                        if (input.value === user.welcome_meal) {
                            input.checked = true;
                        }
                    });
                    console.log("welcome meal: " + user.welcome_meal);

                    let pizzaInputs = form.querySelectorAll('input[name="pizza"]');
                    pizzaInputs.forEach(input => {
                        if (input.value === user.pizza) {
                            input.checked = true;
                        }
                    });
                    console.log("pizza: " + user.pizza);

                    let pizzaMealInputs = form.querySelectorAll('input[name="pizza-meal"]');
                    pizzaMealInputs.forEach(input => {
                        if (input.value === user.pizza_meal) {
                            input.checked = true;
                        }
                    });
                    console.log("pizza meal: " + user.pizza_meal);

                    let stayInputs = form.querySelectorAll('input[name="stay"]');
                    stayInputs.forEach(input => {
                        if (input.value === user.stay) {
                            input.checked = true;
                        }
                    });
                    console.log("stay: " + user.stay);

                    // Show or hide tertiary questions based on primary question
                    let primaryQuestions = form.querySelectorAll('.primary-question');
                    primaryQuestions.forEach(function(question) {
                        // Add an event listener to each input element in the question
                        question.addEventListener('change', function(event) {
                            handleInputChange(form, question, event.target.value);
                        });

                        // Initialize the linked question based on the primary question value
                        let checkedInput = question.querySelector('input:checked');
                        if (checkedInput) {
                            handleInputChange(form, question, checkedInput.value);
                        }
                    });

                    // Append the form to the body of the document
                    document.getElementById('nameModal').style.display = 'none';
                    form.style.display = 'block';
                    document.getElementById('form-container').style.display = 'block';
                    document.getElementById('form-container').prepend(form);

                    // Manually call handlers to show/hide certain questions
                    handleButtonClick(form.id, attendingInput.value);
                    handleKidsOptions(form);
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        function handleKidsOptions(userForm) {
            is_kid = userForm.querySelector('input[name="is_child"]').value;
            console.log("is_kid: " + is_kid);
            if(is_kid === "false") {
                console.log("User is an adult");
                let babysitterQuestion = userForm.querySelector('#babysitter-question');
                babysitterQuestion.style.display = 'none';
                babysitterQuestion.querySelectorAll('input, select, textarea').forEach(input => input.required = false);
                let weddingMeal = userForm.querySelector('#wedding-meal');
                weddingMeal.style.display = 'block';
                weddingMeal.querySelectorAll('input, select, textarea').forEach(input => input.required = true);
            }else{
                console.log("User is a child");
                let babysitterQuestion = userForm.querySelector('#babysitter-question');
                babysitterQuestion.style.display = 'block';
                babysitterQuestion.querySelectorAll('input, select, textarea').forEach(input => input.required = true);
                let weddingMeal = userForm.querySelector('#wedding-meal');
                weddingMeal.style.display = 'none';
                weddingMeal.querySelectorAll('input, select, textarea').forEach(input => input.required = false);
            }
        }

        function handleInputChange(userForm, question, inputValue) {
            // Get the linked question ID
            let linkedQuestionId = question.dataset.linkedQuestion;
            console.log("linkedQuestionId: " + linkedQuestionId);

           // Get the linked question element
           let linkedQuestion = userForm.querySelector(`.tertiary-question[data-question-id="${linkedQuestionId}"]`);
            console.log("linkedQuestion: ");
            console.log(linkedQuestion);
            console.log("inputValue: " + inputValue);

            // Get all input elements within the linked question
            let inputs = linkedQuestion.querySelectorAll('input');
        
            // Modify the linked question based on the input value
            if (inputValue === 'yes') {
                linkedQuestion.style.display = 'flex';
                linkedQuestion.classList.add('tertiary-question-flex');
                inputs.forEach(function(input) {
                    input.required = true;
                    input.classList.add('tertiary-input');
                });
            } else {
                linkedQuestion.style.display = 'none';
                linkedQuestion.classList.remove('tertiary-question-flex');
                inputs.forEach(function(input) {
                    input.required = false;
                    input.classList.remove('tertiary-input');
                });
            }

            console.log("linkedQuestion input required: " + linkedQuestion.querySelector('input').required);
        }

        function handleButtonClick(userForm, option) {
            console.log('handleButtonClick called with userForm:', userForm, 'and option:', option);

            // Get the form and check if it exists
            let form = document.getElementById(userForm);
            if (!form) {
                console.log('Form not found:', userForm);
                return;
            }

            // Get the attendingInput and check if it exists
            let attendingInput = form.querySelector('#attendingInput');
            if (!attendingInput) {
                console.log('attendingInput not found in form:', userForm);
                return;
            }

            // Update the hidden input value in the form
            attendingInput.value = option;

            // Get the acceptedButton and check if it exists
            let acceptedButton = form.querySelector('#acceptedButton');
            if (!acceptedButton) {
                console.log('acceptedButton not found in form:', userForm);
                return;
            }

            // Get the declineButton and check if it exists
            let declineButton = form.querySelector('#declineButton');
            if (!declineButton) {
                console.log('declineButton not found in form:', userForm);
                return;
            }

            // Style the buttons to indicate the selected option
            acceptedButton.classList.toggle('selected', option === 'accepted');
            declineButton.classList.toggle('selected', option === 'decline');

            // Show or hide secondary questions based on attending option
            let secondaryQuestions = form.querySelectorAll('.secondary-question');
            console.log("secondaryQuestions: ");
            console.log(secondaryQuestions);

            secondaryQuestions.forEach(function(question) {
                let inputs = question.querySelectorAll('input, select, textarea');
                if (option !== 'decline') {
                    question.style.display = 'block';
                    question.required = true;
                    inputs.forEach(input => input.required = true);
                } else {
                    question.style.display = 'none';
                    inputs.forEach(input => input.required = false);
                    console.log("question: " + question.id + " hidden and required: " + question.required);
                }
            });

            // Reset dispalying of certain questions for children
            if (option === 'accepted') {
                handleKidsOptions(form);
            }
        }

        // Process data from form before sending it server-side
        document.addEventListener("DOMContentLoaded", function() {
            console.log('form container:' + document.getElementById('form-container'));
            document.getElementById('submit-button').addEventListener('click', function (event) {

                console.log("form-contianer Form submitted");
                
                // Needed this line to stop bug causing form to submit twice when I moved it to Django
                event.stopImmediatePropagation();

                var formDataArray = [];
                let forms = document.getElementById('form-container').querySelectorAll('form');
                console.log("forms: " + forms);

                // Validate the form data
                for (let form of forms) {
                    console.log("form: " + form);
                    let inputGroups = form.querySelectorAll('.radio-group');
                    let allGroupsValid = true;

                    inputGroups.forEach(function(group) {
                        let inputs = group.querySelectorAll('input[required], select[required], textarea[required]');
                        let allInputsValid = true;
                        inputs.forEach(function(input) {
                            if (!input.checkValidity()) {
                                allInputsValid = false;
                                // Add a class to the invalid input to highlight it
                                input.classList.add('invalid-input');
                            } else {
                                // Remove the invalid class if the input is valid
                                input.classList.remove('invalid-input');
                            }
                        });

                        if (!allInputsValid) {
                            allGroupsValid = false;
                            // Create an error message element and insert it after the group of inputs
                            let errorMessage = group.querySelector('.error-message');
                            if (!errorMessage) {
                                errorMessage = document.createElement('div');
                                errorMessage.classList.add('error-message');
                                group.appendChild(errorMessage);
                            }
                            errorMessage.textContent = 'This field is required';
                        } else {
                            // Remove the error message if all inputs in the group are valid
                            let errorMessage = group.querySelector('.error-message');
                            if (errorMessage) {
                                errorMessage.remove();
                            }
                        }
                    });

                    console.log("allGroupsValid: " + allGroupsValid)
                    if (!allGroupsValid) {
                        console.log('Form:' + form.id + ' is invalid');
                        return;
                    }
                }

                // Get all form data 
                forms.forEach(function(form) {
                    // Create a FormData object for each form
                    var formData = new FormData(form);
                    // Convert the form data to an object
                    var formDataObject = {};
                    // TODO: do this individually for each field and have type specific checks for each
                    formData.forEach(function (value, key) {
                        formDataObject[key] = value;
                    });
                    // Add the object to the array
                    formDataArray.push(formDataObject);
                });

                console.log("formDataArray: ");
                console.log(formDataArray);

                // Store the form data in local storage
                //This is robably not needed - TODO: remove
                formDataArray.forEach(function(form){
                    console.log("form: ");
                    console.log(form);
                    let name = form['full-name'];
                    localStorage.setItem(`${name}_Data`, JSON.stringify(form));
                });

                // Send the form data to the server, using a relative path to the Django view
                fetch('/submit_rsvp/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formDataArray),
                })
                .then(response => {
                    if (response.headers.get("content-type").includes("application/json")) {
                        return response.json();
                    } else {
                        throw new Error('Received content type ' + response.headers.get("content-type"));
                    }
                })
                .then(data => {
                    // Handle the response from the server if needed
                    console.log("Response from server:");
                    console.log(data);

                    // Redirect to a thank you page
                    if(formDataArray.length > 0){
                        let isAttending = false;
                        for (let form of formDataArray) {
                            if (form.attending === "accepted") {
                                isAttending = true;
                                break;
                            }
                        }
                        if (isAttending) {
                            window.location.href = `{% url 'thanks_accepted' %}`;
                        } else {
                            window.location.href = `{% url 'thanks_declined' %}`;
                        }
                    }
                })
                .catch(error => {
                    // Handle errors
                    console.error('Error:', error);
                    alert('Error sending POST request: ' + error.message);
                });

                console.log("formDataArray after fetch:");
                console.log(JSON.stringify(formDataArray));
            });
        });

        document.addEventListener('submit', function (event) {
            console.log('Submit event fired');
        });

    </script>

</body>

{% endblock %}